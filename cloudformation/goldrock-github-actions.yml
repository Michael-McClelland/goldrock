---
AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  GitHubOrg:
    Description: Name of GitHub organization/user (case sensitive)
    Default: "Michael-McClelland"
    Type: String
  RepositoryName:
    Description: Name of GitHub repository (case sensitive)
    Default: "goldrock"
    Type: String
  OIDCProviderArn:
    Description: Arn for the GitHub OIDC Provider.  If a Github OIDC has not yet been deployed leave this as blank.
    Default: ""
    Type: String
  OIDCAudience:
    Description: Audience supplied to configure-aws-credentials.
    Default: "sts.amazonaws.com"
    Type: String

Conditions:
  CreateOIDCProvider: !Equals [!Ref OIDCProviderArn, ""]
Resources:

  CustomOrganizationsInformation:
    Type: "Custom::Organizations-Attributes"
    DependsOn:
      - CROrgFunction
      - CROrgFunctionRole
      - CROrgFunctionPolicy
    Properties:
      ServiceTimeout: 60
      ServiceToken: !GetAtt "CROrgFunction.Arn"

  CROrgFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.lambda_handler
      ReservedConcurrentExecutions: 1
      Timeout: 90
      Role: !GetAtt "CROrgFunctionRole.Arn"
      Runtime: python3.13
      Architectures:
        - arm64
      Code:
        ZipFile: |
          import boto3
          import cfnresponse

          def lambda_handler(event, context):
            responseData = {}
            if event['RequestType'] == 'Delete':
              cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)
              return
            organizations_client = boto3.client('organizations')
            list_root_response = organizations_client.list_roots()
            responseData['OrganizationRootId'] = list_root_response['Roots'][0]['Id']
            describe_organization_id =  organizations_client.describe_organization()
            responseData['OrganizationId'] = describe_organization_id['Organization']['Id']
            cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, "OrganizationsInformation")

  CROrgFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
            Condition: {}
      Path: /

  CROrgFunctionPolicy:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      Description: Policy organization information custom resource
      Roles:
        - !Ref CROrgFunctionRole
      Path: /
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - organizations:ListRoots
              - organizations:DescribeOrganization
              - organizations:DescribeOrganizationalUnit
            Resource: "*"
          - Effect: Allow
            Action: logs:CreateLogGroup
            Resource: !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:*" #TODO MAKE LOGGROUP FOR FUNCTION?!?!?
          - Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:PutLogEvents
            Resource: !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/OrganizationsInformation:*" #TODO
  Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "goldrock-github-actions"
      MaxSessionDuration: 43200
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !If
                - CreateOIDCProvider
                - !Ref GithubOidc
                - !Ref OIDCProviderArn
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: !Ref OIDCAudience
                token.actions.githubusercontent.com:sub: !Sub repo:${GitHubOrg}/${RepositoryName}:ref:refs/heads/main
                
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess

  GithubOidc:
    Type: AWS::IAM::OIDCProvider
    Condition: CreateOIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 6938fd4d98bab03faadb97b34396831e3780aea1

  ReadOnlyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "goldrock-github-actions-read-only"
      MaxSessionDuration: 43200
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Action: sts:AssumeRoleWithWebIdentity
            Principal:
              Federated: !If
                - CreateOIDCProvider
                - !Ref GithubOidc
                - !Ref OIDCProviderArn
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: !Ref OIDCAudience
              StringLike:
                token.actions.githubusercontent.com:sub: !Sub repo:${GitHubOrg}/${RepositoryName}:ref:refs/heads/*
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/job-function/ViewOnlyAccess
        - arn:aws:iam::aws:policy/IAMReadOnlyAccess

  EnableRAMTrust:
    Type: Custom::EnableRAMTrust
    Properties:
      ServiceToken: !GetAtt EnableRAMTrustFunction.Arn

  EnableRAMTrustFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.lambda_handler
      Runtime: python3.13
      Timeout: 120
      Role: !GetAtt EnableRAMTrustRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          import time
          
          def lambda_handler(event, context):
            try:
              if event['RequestType'] == 'Delete':
                cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                return
                
              ram = boto3.client('ram')
              
              # Check if RAM organizational trust is enabled
              try:
                response = ram.get_resource_share_associations(associationType='RESOURCE')
                # If we can call this without error, trust is likely enabled
              except Exception:
                # Enable organizational trust for RAM
                ram.enable_sharing_with_aws_organization()
                time.sleep(60)  # Sleep for 1 minute after activation
                
              cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
            except Exception as e:
              cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

  EnableRAMTrustRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: RAMAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ram:EnableSharingWithAwsOrganization
                  - ram:GetResourceShareAssociations
                Resource: '*'

  GitHubCodeConnection:
    Type: AWS::CodeConnections::Connection
    Properties:
      ConnectionName: !Sub "goldrock-${GitHubOrg}"
      ProviderType: GitHub
      Tags:
        - Key: Organization
          Value: !Ref GitHubOrg

  CodeBuildSourceCredential:
    Type: Custom::CodeBuildSourceCredential
    Properties:
      ServiceToken: !GetAtt SourceCredentialFunction.Arn
      ServerType: GITHUB
      AuthType: CODECONNECTIONS
      Resource: !Ref GitHubCodeConnection

  SourceCredentialFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.lambda_handler
      Runtime: python3.13
      Timeout: 60
      Role: !GetAtt SourceCredentialRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          
          def lambda_handler(event, context):
            try:
              codebuild = boto3.client('codebuild')
              
              if event['RequestType'] == 'Create':
                response = codebuild.import_source_credentials(
                  serverType=event['ResourceProperties']['ServerType'],
                  authType=event['ResourceProperties']['AuthType'],
                  token=event['ResourceProperties']['Resource']
                )
                cfnresponse.send(event, context, cfnresponse.SUCCESS, {'Arn': response['arn']})
              elif event['RequestType'] == 'Delete':
                try:
                  codebuild.delete_source_credentials(
                    arn=event['PhysicalResourceId']
                  )
                except:
                  pass
                cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
              else:
                cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
            except Exception as e:
              cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

  SourceCredentialRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CodeBuildCredentials
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - codebuild:ImportSourceCredentials
                  - codebuild:DeleteSourceCredentials
                  - codebuild:ListSourceCredentials
                Resource: '*'

  ConnectionShare:
    Type: AWS::RAM::ResourceShare
    Properties:
      Name: github-connection-share
      ResourceArns:
        - !Ref GitHubCodeConnection
      Principals:
        - !Sub 'arn:aws:organizations::${AWS::AccountId}:organization/${CustomOrganizationsInformation.OrganizationId}'
      AllowExternalPrincipals: false
      Tags:
        - Key: Organization
          Value: !Ref GitHubOrg

  ECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: goldrock-codebuild-ubuntu-runner-image
      ImageTagMutability: MUTABLE
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "Keep last 3 images",
                "selection": {
                  "tagStatus": "any",
                  "countType": "imageCountMoreThan",
                  "countNumber": 3
                },
                "action": {
                  "type": "expire"
                }
              }
            ]
          }
      Tags:
        - Key: placeholder
          Value: 'placeholder'


  ImageBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: goldrock-codebuild-ubuntu-image-builder
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Source:
        Type: NO_SOURCE
        BuildSpec: |
          version: 0.2
          phases:
            build:
              commands:
                - |
                  cat > Dockerfile << 'EOF'
                  FROM ubuntu:25.10
                  
                  ENV DEBIAN_FRONTEND=noninteractive
                  
                  # Install dependencies including Python
                  RUN apt-get update && apt-get install -y \
                      python3 \
                      python3-pip \
                      curl \
                      wget \
                      unzip \
                      git \
                      jq \
                      sudo \
                      gnupg \
                      gpg \
                      lsb-release \
                      libicu-dev \
                      ca-certificates \
                      && rm -rf /var/lib/apt/lists/* \
                      && python3 --version \
                      && sleep 20
                  
                  # Install Node.js
                  RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - && \
                      sudo apt-get install -y nodejs
                  
                  # Install GitHub Actions runner
                  RUN useradd -m -s /bin/bash runner && \
                      echo "runner ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
                  
                  USER runner
                  WORKDIR /home/runner
                  
                  # Download and install GitHub Actions runner
                  RUN RUNNER_VERSION=$(curl --silent "https://api.github.com/repos/actions/runner/releases/latest" | jq -r '.tag_name') && \
                      curl -o actions-runner-linux-x64.tar.gz -L "https://github.com/actions/runner/releases/download/${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION#v}.tar.gz" && \
                      tar xzf actions-runner-linux-x64.tar.gz && \
                      rm actions-runner-linux-x64.tar.gz
                  
                  # Install AWS CLI
                  RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
                      unzip awscliv2.zip && \
                      sudo ./aws/install && \
                      rm -rf awscliv2.zip aws
                  
                  # Install Terraform
                  RUN TERRAFORM_VERSION=$(curl -s https://api.github.com/repos/hashicorp/terraform/releases/latest | jq -r '.tag_name' | sed 's/v//') && \
                      wget https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip && \
                      unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip && \
                      sudo mv terraform /usr/local/bin/ && \
                      rm terraform_${TERRAFORM_VERSION}_linux_amd64.zip
                  
                  ENTRYPOINT ["./run.sh"]
                  EOF
                - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPO
                - docker build -t $ECR_REPO:latest .
                - docker push $ECR_REPO:latest
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        PrivilegedMode: true
        EnvironmentVariables:
          - Name: ECR_REPO
            Value: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepository}
      Artifacts:
        Type: NO_ARTIFACTS
      Tags:
        - Key: placeholder
          Value: 'placeholder'


  BuildSchedule:
    Type: AWS::Events::Rule
    Properties:
      ScheduleExpression: rate(7 days)
      State: ENABLED
      Targets:
        - Arn: !GetAtt ImageBuildProject.Arn
          RoleArn: !GetAtt EventBridgeRole.Arn
          Id: ImageBuildTarget
      Tags:
        - Key: placeholder
          Value: 'placeholder'


  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: goldrock-codebuild-ubuntu-runner-image
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: ECRAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                  - ecr:PutImage
                  - ecr:InitiateLayerUpload
                  - ecr:UploadLayerPart
                  - ecr:CompleteLayerUpload
                Resource: '*'
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
      Tags:
        - Key: placeholder
          Value: 'placeholder'


  EventBridgeRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: goldrock-codebuild-runner-images-eventbridge
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: StartBuild
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: codebuild:StartBuild
                Resource: !GetAtt ImageBuildProject.Arn
      Tags:
        - Key: placeholder
          Value: 'placeholder'

  TriggerBuild:
    Type: Custom::TriggerBuild
    DependsOn:
      - ImageBuildProject
      - ECRRepository
    Properties:
      ServiceToken: !GetAtt TriggerBuildFunction.Arn
      ProjectName: !Ref ImageBuildProject

  TriggerBuildFunction:
    Type: AWS::Lambda::Function
    Properties:
      Handler: index.lambda_handler
      Runtime: python3.13
      Timeout: 60
      Role: !GetAtt TriggerBuildRole.Arn
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          
          def lambda_handler(event, context):
            try:
              if event['RequestType'] == 'Create':
                codebuild = boto3.client('codebuild')
                project_name = event['ResourceProperties']['ProjectName']
                response = codebuild.start_build(projectName=project_name)
                cfnresponse.send(event, context, cfnresponse.SUCCESS, {'BuildId': response['build']['id']})
              else:
                cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
            except Exception as e:
              cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

  TriggerBuildRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: StartBuild
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: codebuild:StartBuild
                Resource: !GetAtt ImageBuildProject.Arn

  GoldrockProject:
    Type: AWS::CodeBuild::Project
    DependsOn: TriggerBuild
    Properties:
      Name: goldrock
      ServiceRole: !GetAtt GoldrockCodeBuildRole.Arn
      Source:
        Type: GITHUB
        Location: !Sub "https://github.com/${GitHubOrg}/${RepositoryName}"
        GitCloneDepth: 0
        GitSubmodulesConfig:
          FetchSubmodules: true
        ReportBuildStatus: false
        Auth:
          Type: CODECONNECTIONS
          Resource: !Ref GitHubCodeConnection
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepository}:latest"
        ImagePullCredentialsType: SERVICE_ROLE
        PrivilegedMode: true
      BadgeEnabled: false
      Cache:
        Type: NO_CACHE
      Artifacts:
        Type: NO_ARTIFACTS
      TimeoutInMinutes: 30
      QueuedTimeoutInMinutes: 30
      Triggers:
        Webhook: true
        FilterGroups:
          - - Type: EVENT
              Pattern: WORKFLOW_JOB_QUEUED
      Tags:
        - Key: Organization
          Value: !Ref GitHubOrg

  GoldrockCodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: goldrock-codebuild-runner
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeConnectionsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - codeconnections:CreateWebhook
                  - codeconnections:DeleteWebhook
                  - codeconnections:GetConnection
                  - codeconnections:GetConnectionToken
                  - codeconnections:ListWebhooks
                  - codeconnections:UseConnection
                  - codeconnections:UseConnection
                Resource: '*'
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                Resource: '*'
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
      Tags:
        - Key: Organization
          Value: !Ref GitHubOrg

  OIDCSTACKSET:
    Type: "AWS::CloudFormation::StackSet"
    Properties:
      StackSetName: goldrock-github-actions
      Description: OIDC provider for infrastructure management
      PermissionModel: SERVICE_MANAGED
      Capabilities: 
        - CAPABILITY_NAMED_IAM
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      ManagedExecution:
        Active: true
      OperationPreferences:
        MaxConcurrentPercentage: 100
        FailureTolerancePercentage: 10
        ConcurrencyMode: SOFT_FAILURE_TOLERANCE
        RegionConcurrencyType: PARALLEL

      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !GetAtt CustomOrganizationsInformation.OrganizationRootId
          Regions:
            - !Sub ${AWS::Region}
      Parameters:
        - ParameterKey: GitHubOrg
          ParameterValue: !Ref GitHubOrg
        - ParameterKey: RepositoryName
          ParameterValue: !Ref RepositoryName
        - ParameterKey: OIDCProviderArn
          ParameterValue: !Ref OIDCProviderArn
        - ParameterKey: OIDCAudience
          ParameterValue: !Ref OIDCAudience
        
      Tags:
        - Key: tag1
          Value: value1
      TemplateBody: |
        ---
        AWSTemplateFormatVersion: '2010-09-09'
        Parameters:
          GitHubOrg:
            Description: Name of GitHub organization/user (case sensitive)
            Type: String
          RepositoryName:
            Description: Name of GitHub repository (case sensitive)
            Type: String
          OIDCProviderArn:
            Description: Arn for the GitHub OIDC Provider.  If a Github OIDC has not yet been deployed leave this as blank.
            Default: ""
            Type: String
          OIDCAudience:
            Description: Audience supplied to configure-aws-credentials.
            Type: String

        Conditions:
          CreateOIDCProvider: !Equals [!Ref OIDCProviderArn, ""]

        Resources:
          Role:
            Type: AWS::IAM::Role
            Properties:
              RoleName: !Sub "goldrock-github-actions"
              MaxSessionDuration: 14400
              AssumeRolePolicyDocument:
                Statement:
                  - Effect: Allow
                    Action: sts:AssumeRoleWithWebIdentity
                    Principal:
                      Federated: !If
                        - CreateOIDCProvider
                        - !Ref GithubOidc
                        - !Ref OIDCProviderArn
                    Condition:
                      StringEquals:
                        token.actions.githubusercontent.com:aud: !Ref OIDCAudience
                        token.actions.githubusercontent.com:sub: !Sub repo:${GitHubOrg}/${RepositoryName}:ref:refs/heads/main
                        
              ManagedPolicyArns:
                - arn:aws:iam::aws:policy/AdministratorAccess

          GithubOidc:
            Type: AWS::IAM::OIDCProvider
            Condition: CreateOIDCProvider
            Properties:
              Url: https://token.actions.githubusercontent.com
              ClientIdList:
                - sts.amazonaws.com
              ThumbprintList:
                - 6938fd4d98bab03faadb97b34396831e3780aea1

          ReadOnlyRole:
            Type: AWS::IAM::Role
            Properties:
              RoleName: "goldrock-github-actions-read-only"
              MaxSessionDuration: 43200
              AssumeRolePolicyDocument:
                Statement:
                  - Effect: Allow
                    Action: sts:AssumeRoleWithWebIdentity
                    Principal:
                      Federated: !If
                        - CreateOIDCProvider
                        - !Ref GithubOidc
                        - !Ref OIDCProviderArn
                    Condition:
                      StringEquals:
                        token.actions.githubusercontent.com:aud: !Ref OIDCAudience
                      StringLike:
                        token.actions.githubusercontent.com:sub: !Sub repo:${GitHubOrg}/${RepositoryName}:ref:refs/heads/*
              ManagedPolicyArns:
                - arn:aws:iam::aws:policy/job-function/ViewOnlyAccess
                - arn:aws:iam::aws:policy/IAMReadOnlyAccess

          CodeBuildSourceCredential:
            Type: Custom::CodeBuildSourceCredential
            Properties:
              ServiceToken: !GetAtt SourceCredentialFunction.Arn
              ServerType: GITHUB
              AuthType: OAUTH

          SourceCredentialFunction:
            Type: AWS::Lambda::Function
            Properties:
              Handler: index.lambda_handler
              Runtime: python3.13
              Timeout: 60
              Role: !GetAtt SourceCredentialRole.Arn
              Code:
                ZipFile: |
                  import boto3
                  import cfnresponse
                  
                  def lambda_handler(event, context):
                    try:
                      codebuild = boto3.client('codebuild')
                      
                      if event['RequestType'] == 'Create':
                        # For child accounts, use shared connection via RAM
                        cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      else:
                        cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                    except Exception as e:
                      cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

          SourceCredentialRole:
            Type: AWS::IAM::Role
            Properties:
              AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: Allow
                    Principal:
                      Service: lambda.amazonaws.com
                    Action: sts:AssumeRole
              ManagedPolicyArns:
                - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
              Policies:
                - PolicyName: CodeBuildCredentials
                  PolicyDocument:
                    Version: '2012-10-17'
                    Statement:
                      - Effect: Allow
                        Action:
                          - codebuild:ImportSourceCredentials
                          - codebuild:DeleteSourceCredentials
                          - codebuild:ListSourceCredentials
                        Resource: '*'
